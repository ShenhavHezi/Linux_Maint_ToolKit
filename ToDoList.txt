# linux-maint — ToDoList (roadmap refresh)

This is the single backlog source of truth.

## Working style
- Bundle related roadmap items into PRs when it improves delivery and review flow.
- Changes can be broad when needed, but must remain test-backed and clearly documented.
- Prioritize operator clarity and safe defaults over feature count.
- Dark-site/offline reliability remains a primary product focus.

## Priority legend
- **P0**: correctness/contract/runtime reliability
- **P1**: operator UX and understandability
- **P2**: security and hardening
- **P3**: observability/reporting quality
- **P4**: DX/release/packaging polish

## Tags
- `[dark-site]` offline/air-gapped operator flow
- `[contract]` summary/output guarantees and parser safety
- `[ops]` runbook/doctor/operator experience
- `[security]` hardening and data handling
- `[dx]` contributor and release workflow

---

## P0 — Correctness / contract / runtime reliability

### P0.1 [contract] Add a strict machine-output compatibility gate for `status --json`
**Why**: automation depends on stable keys/types; accidental output drift can break internal tooling.

**Where**:
- `bin/linux-maint`
- `tests/status_json_test.sh`
- `docs/reference.md`

**Acceptance**:
- Define versioned JSON compatibility policy (required keys + type guarantees).
- Add explicit regression assertions for key presence/type and nullability behavior.
- Document compatibility expectations and deprecation path.

**Verify**:
- Extend JSON tests with schema-like assertions and backward-compat fixtures.

---

### P0.2 [contract] Add monitor summary dedup/canonicalization tests for repeated emissions
**Why**: some monitors can emit multiple lines per host; rollups/diffs need deterministic behavior.

**Where**:
- `run_full_health_monitor.sh`
- `tools/summary_diff.py`
- `tests/monitor_summary_emission_test.sh`

**Acceptance**:
- Define canonical rule for repeated monitor/host lines (last-wins vs worst-status-wins).
- Apply the same rule to text summary, JSON summary, and diff tooling.

**Verify**:
- Add fixtures with repeated lines and mixed severities; assert deterministic output.

---

### P0.3 [dark-site][ops] Improve failure resilience when writable log/state dirs are unavailable
**Why**: restricted hosts sometimes block `/var/log`/`/var/lib`; failures should degrade predictably.

**Where**:
- `run_full_health_monitor.sh`
- `lib/linux_maint.sh`
- `tests/*` (new fallback-path test)

**Acceptance**:
- Centralize fallback chain for logs/state in one helper.
- Emit explicit warning summary when fallback paths are used.
- Avoid partial-run silent failures.

**Verify**:
- Add test that simulates unwritable default paths and confirms graceful completion.

---

## P1 — Operator UX and understandability

### P1.1 [ops] Add `linux-maint explain <reason>` command linked to `docs/REASONS.md`
**Why**: on-call users seeing `reason=` tokens need immediate remediation guidance.

**Where**:
- `bin/linux-maint`
- `docs/REASONS.md`
- `docs/QUICK_REFERENCE.md`
- `tests/explain_reason_test.sh`

**Acceptance**:
- Command prints concise explanation + likely causes + next checks.
- Clear behavior for unknown/typo reason tokens.

**Verify**:
- Add tests for known token, unknown token, and JSON/human output parity (if JSON mode added).

---

### P1.2 [ops] Add `linux-maint status --since <duration>` for recent-run focus (DONE 2026-02-17)
**Why**: operators often only care about recent health regressions, not full history tail.

**Where**:
- `bin/linux-maint`
- `tests/status_since_test.sh`
- `README.md`, `docs/QUICK_REFERENCE.md`

**Acceptance**:
- Support duration parsing (`15m`, `2h`, `1d`, `30s`) against timestamped summary artifacts.
- Preserve existing defaults when flag is omitted.

**Verify**:
- ✅ Implemented: `linux-maint status` now supports `--since <duration>` for both compact and `--json` modes and filters by timestamped summary files only.
- ✅ Coverage: added `tests/status_since_test.sh` for include/exclude filtering and invalid-duration validation (`rc=2`).

---

### P1.3 [dark-site] Publish a “first 30 minutes” runbook section for offline onboarding
**Why**: onboarding friction remains high for new admins in constrained environments.

**Where**:
- `docs/DARK_SITE.md`
- `README.md`

**Acceptance**:
- Step-by-step minimal setup, first run, common SKIP reasons, and immediate triage.
- Include copy/paste-safe commands and expected outputs.

**Verify**:
- Runbook walkthrough validated on a clean VM/container.

---

## P2 — Security / hardening

### P2.1 [security] Add optional secret scanning lint for committed fixtures/docs
**Why**: test fixtures and docs are common accidental secret-leak vectors.

**Where**:
- `tools/` (new scanner wrapper)
- `.github/workflows/ci.yml`
- `tests/` (fixture allowlist tests)

**Acceptance**:
- Add lightweight scanner integration with explicit allowlist for known safe test tokens.
- CI should fail only on high-confidence leaks.

**Verify**:
- Add positive/negative fixtures to validate signal/noise behavior.

---

### P2.2 [security] Add checksum/signature verification path for offline release tarballs
**Why**: dark-site transfer paths need integrity verification before installation.

**Where**:
- `tools/make_tarball.sh`
- `install.sh`
- `docs/README.md` / `docs/DARK_SITE.md`

**Acceptance**:
- Generate checksums (and optional detached signatures) with clear verify command.
- Installer docs include verification as a required step.

**Verify**:
- Add test for checksum generation and verification failure on tampered archive.

---

## P3 — Observability / reporting quality

### P3.1 [contract] Add summary trend report utility (`linux-maint trend`) for reason/severity drift
**Why**: teams need trend visibility, not only latest snapshot.

**Where**:
- `bin/linux-maint`
- `tools/` (optional parser helper)
- `tests/` (new trend fixtures)

**Acceptance**:
- Show reason/severity counts over last N runs.
- Keep output deterministic and script-friendly.

**Verify**:
- Fixture tests for stable sort/order and numeric correctness.

---

### P3.2 [ops] Improve Prometheus export metadata for monitor and reason dimensions
**Why**: dashboards and alerts benefit from consistent labels and clear metric help text.

**Where**:
- `run_full_health_monitor.sh`
- `docs/reference.md`
- `tests/prom_textfile_output_test.sh`

**Acceptance**:
- Ensure label set is consistent and bounded.
- Update HELP/TYPE docs and examples.

**Verify**:
- Extend prom textfile tests for label consistency and expected cardinality.

---

## P4 — DX / release / packaging polish

### P4.1 [dx] Add a lightweight local “quick-check” target for contributors
**Why**: full smoke can be slow during iteration; contributors need a fast guardrail.

**Where**:
- `Makefile`
- `tools/dev_check.sh`
- `CONTRIBUTING.md`

**Acceptance**:
- Add `make quick-check` (syntax + key contract lints only).
- Keep `make test` and `make dev-check` as full checks.

**Verify**:
- Add/adjust one Make-target test to ensure target exists and runs expected commands.

---

### P4.2 [dx] Add architecture diagram + data-flow doc for wrapper/monitors/artifacts
**Why**: repo is mature but mental model is still hard for new contributors.

**Where**:
- `docs/INDEX.md`
- `docs/reference.md`
- `docs/README.md`

**Acceptance**:
- Include one concise architecture diagram and lifecycle walkthrough.
- Cross-link from README and quick reference.

**Verify**:
- Docs review: a new contributor can locate command flow and artifact paths in <10 minutes.
