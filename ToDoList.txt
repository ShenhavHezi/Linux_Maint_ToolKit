# linux-maint — Roadmap / ToDoList (prioritized)

This file is the project backlog.

Principles:
- Keep changes small and safe; assume the toolkit already works.
- Prefer fixing real operational issues over cosmetic refactors.
- Do not add large dependencies.
- ShellCheck policy:
  - `.shellcheckrc` is the canonical exclude list.
  - Do NOT exclude SC2086 globally.
  - If a warning is intentional, disable it locally.

---

## P0 — CI/tooling correctness & contract enforcement (highest priority)

### P0.1 Single source of truth for ShellCheck excludes (NOT DONE)

**Why**: CI/pre-commit/lint must be consistent; drift breaks PRs and wastes time.

**Where**:
- `.shellcheckrc`
- `.github/workflows/ci.yml`
- `tools/pre-commit.sh`
- `Makefile`

**Acceptance**:
- `.shellcheckrc` is the *only* maintained exclude list.
- CI and pre-commit derive excludes from `.shellcheckrc` automatically (no duplication).
- SC2086 is **not** excluded globally.

**Verify**:
- CI ShellCheck passes.
- `make lint` and pre-commit output match CI.

---

### P0.2 Enforce safe/consistent `lm_summary` key=value quoting (NOT DONE)

**Why**: unquoted values create SC2086 churn and can break machine parsing.

**Where**:
- all monitors (any `lm_summary ... key=value` usage)

**Acceptance**:
- All `lm_summary` calls use `key="$value"` for variable values (even numeric).
- No new SC2086 introduced.

**Verify**:
- ShellCheck finds 0 SC2086.
- `tests/summary_contract.sh` still passes.

---

### P0.3 Add lint test: summary line parse safety (NOT DONE)

**Why**: prevent regressions that break parsers/automation.

**Where**:
- `tests/` (new test)

**Acceptance**:
- New test fails if any `monitor=` line:
  - misses required keys
  - contains unescaped spaces in values
  - contains duplicate keys

**Verify**:
- Included in `tests/smoke.sh`.

---

### P0.4 CI: enforce meta-doc updates on PRs (DONE)

**Why**: keep GitHub landing page and roadmap accurate.

**Where**:
- `.github/workflows/docs_consistency.yml`

**Acceptance**:
- CI fails on PRs with code changes unless `ToDoList.txt` or `summarize.txt` is updated.

---

## P1 — Security hardening (practical, low risk)

### P1.1 Harden SSH defaults & document policy (NOT DONE)

**Why**: SSH execution is the primary remote surface; defaults should be safe and predictable.

**Where**:
- `lib/linux_maint.sh` (ssh wrapper)
- docs (`docs/reference.md`)

**Acceptance**:
- Document recommended `LM_SSH_OPTS` baseline (BatchMode, ConnectTimeout, etc.).
- Add optional `LM_SSH_HARDENED=1` to apply safe defaults when user didn’t override.

**Verify**:
- `--dry-run` still performs no SSH.
- Fleet run works with explicit `LM_SSH_OPTS` unchanged.

---

### P1.2 Log redaction (optional toggle) (NOT DONE)

**Why**: avoid accidental leakage of secrets/tokens into logs.

**Where**:
- `lib/linux_maint.sh` logging helpers

**Acceptance**:
- Optional `LM_REDACT_LOGS=1` redacts common patterns (`token=`, `password=`, `Authorization:`).
- Default behavior unchanged (off).

**Verify**:
- Unit-ish test with sample strings.

---

### P1.3 Standardize temp file safety + cleanup (NOT DONE)

**Why**: many monitors use `mktemp`; ensure consistent permissions and cleanup.

**Where**:
- monitors using temp files

**Acceptance**:
- temp files are created with secure permissions.
- cleanup via `trap` where practical.

**Verify**:
- Basic smoke run; no leftover temp files in `/tmp` in happy paths.

---

## P2 — Operability & on-call UX

### P2.1 Add `linux-maint diff` (wrap `tools/summary_diff.py`) (NOT DONE)

**Why**: diffing summaries is a common triage task.

**Where**:
- `bin/linux-maint`
- `tools/summary_diff.py`

**Acceptance**:
- `linux-maint diff [--from <file>] [--to <file>]` works in installed and repo modes.
- Exit code is non-zero if new CRIT appears (optional flag).

**Verify**:
- Add a small test using fixture summaries.

---

### P2.2 Status history view (NOT DONE)

**Why**: on-call often needs “what changed since last run?”

**Where**:
- `bin/linux-maint` (`status` command)

**Acceptance**:
- `linux-maint status --last N` shows last N runs (best-effort based on logs/last_status_full).

**Verify**:
- Snapshot test in `tests/`.

---

### P2.3 Prometheus textfile output improvements (NOT DONE)

**Why**: make metrics more useful for dashboards/alerts.

**Where**:
- wrapper / formatter
- docs

**Acceptance**:
- Stable metric naming.
- Export counts by status and per-monitor status.

**Verify**:
- A test that validates `.prom` format and key presence.

---

## P3 — New monitor features (value add, controlled scope)

### P3.1 Resource monitor (CPU/mem/swap pressure) (NOT DONE)

**Why**: resource pressure is a common root cause.

**Where**:
- `monitors/resource_monitor.sh` (new)
- docs + summarize

**Acceptance**:
- Emits summary with `status` based on thresholds.
- Uses reasons: `high_load`, `high_mem`, `swap_thrash`.
- Degrades gracefully when commands missing.

**Verify**:
- CI test in minimal environment (missing tools => SKIP/UNKNOWN with reason).

---

### P3.2 Log spike monitor (kernel/service errors rate) (NOT DONE)

**Why**: spikes in kernel or service errors often precede outages.

**Where**:
- new monitor (journald/syslog best-effort)

**Acceptance**:
- Threshold-based WARN/CRIT.
- Reason tokens documented.

**Verify**:
- Test using fixture logs.

---

### P3.3 Cert monitor: directory scan option (NOT DONE)

**Why**: cert sprawl is common; reduce manual config.

**Where**:
- `monitors/cert_monitor.sh`
- docs

**Acceptance**:
- Optional config: scan directory for cert files.
- Supports ignore patterns.

**Verify**:
- Test with generated cert fixtures.

---

## P4 — Packaging & systemd hardening

### P4.1 Systemd hardening for service/timer (NOT DONE)

**Why**: reduce blast radius for root-running automation.

**Where**:
- systemd unit files (RPM + installer templates)

**Acceptance**:
- Add safe hardening directives where compatible (e.g. `NoNewPrivileges=true`).
- Document any constraints.

**Verify**:
- RPM/container smoke still passes.

---

### P4.2 Offline/dark-site release workflow polish (NOT DONE)

**Why**: make releases repeatable.

**Where**:
- `tools/make_tarball.sh`
- `docs/DARK_SITE.md`

**Acceptance**:
- Document checksum + verification.
- Ensure tarball includes needed metadata.

**Verify**:
- Build tarball, install, run `linux-maint status`.

---

## P5 — Developer experience

### P5.1 Add `tools/dev_check.sh` (NOT DONE)

**Why**: one command for contributors.

**Where**:
- `tools/dev_check.sh` (new)

**Acceptance**:
- Runs: `python3 tools/gen_summarize.py`, lint, and tests.

**Verify**:
- Works in repo mode on a typical Linux dev box.
