# linux-maint — ToDoList (next roadmap refresh)

This is the single backlog source of truth.

## Working style
- Pick **one** item per PR.
- Keep changes small, reversible, and test-backed.
- Prefer improving existing behavior over adding new monitors.
- Dark-site/offline reliability is the primary product focus.

## Priority legend
- **P0**: correctness/contract/runtime reliability
- **P1**: dark-site operator experience
- **P2**: security and hardening
- **P3**: signal quality and observability
- **P4**: DX/release polish

## Tags
- `[dark-site]` offline/air-gapped operator flow
- `[contract]` summary/output guarantees and test robustness
- `[ops]` runbook/doctor/operator experience
- `[security]` hardening and data handling
- `[dx]` contributor and release workflow

---

## P0 — Correctness / contract / runtime reliability

### P0.1 [contract] Disk-trend state path determinism for unprivileged runs (DONE 2026-02-16)
**Why**: `disk_trend_monitor` can write state under `/var/lib/linux_maint/disk_trend` when writable, but tests and operators often rely on `LM_STATE_DIR`; this creates ambiguous artifact locations and fragile expectations.

**Where**:
- `monitors/disk_trend_monitor.sh`
- `tests/disk_trend_inode_trend_test.sh`
- `docs/reference.md`

**Acceptance**:
- Define clear precedence for trend state location (e.g., explicit `STATE_BASE` > `LM_STATE_DIR` > `/var/lib/...`).
- Ensure inode + disk trend state follow the same location rules.
- Avoid requiring fallback checks across two directories in tests.

**Verify**:
- Extend/adjust tests to assert a single deterministic state path.
- Run summary contract + inode trend test to confirm no regressions.
- ✅ Implemented: `disk_trend_monitor` now resolves state path deterministically with precedence `STATE_BASE` → `${LM_STATE_DIR}/linux_maint/disk_trend` → `/var/lib/linux_maint/disk_trend` (with logged fallback to `/tmp` only when resolved path is not writable).
- ✅ Coverage: `tests/disk_trend_inode_trend_test.sh` now asserts inode state artifact only at the deterministic `LM_STATE_DIR` path.

---

### P0.2 [contract] Standardize non-OK summary `reason=` coverage (NOT DONE)
**Why**: non-OK summary lines should consistently include `reason=` for reliable automation and on-call triage.

**Where**:
- `monitors/*.sh` (target only missing paths)
- `tests/summary_reason_lint.sh`

**Acceptance**:
- For `WARN|CRIT|UNKNOWN|SKIP`, enforce `reason=` across monitor summary output.
- Keep existing reason vocabulary aligned with `docs/REASONS.md`.

**Verify**:
- Add/extend regression tests for monitors currently missing `reason=` on non-OK outputs.

---

### P0.3 [contract] Wrapper + monitor timeout policy harmonization (NOT DONE)
**Why**: timeout behavior exists at wrapper and contract-test levels, but monitor-level timeouts are inconsistent and not centrally documented.

**Where**:
- `run_full_health_monitor.sh`
- `monitors/*.sh`
- `docs/reference.md`

**Acceptance**:
- Publish a clear timeout policy (wrapper timeout, per-monitor override, command-level timeout usage).
- Ensure long-running monitors use bounded external calls.

**Verify**:
- Add targeted tests for at least one slow/failing external command path.

---

## P1 — Dark-site / offline operator experience

### P1.1 [dark-site][ops] Add `linux-maint doctor --json` for automation (NOT DONE)
**Why**: dark-site operators often need machine-readable diagnostics to integrate with internal runbooks and ticketing.

**Where**:
- `bin/linux-maint`
- `tests/doctor_offline_hints_test.sh` (or new JSON-focused test)
- `docs/reference.md`

**Acceptance**:
- Add JSON mode for doctor output without changing default human output.
- Include key checks: config presence, permissions hints, monitor skip-gates, dependency hints.

**Verify**:
- Validate stable JSON keys via tests.

---

### P1.2 [dark-site] Bootstrap helper for minimum config skeleton (NOT DONE)
**Why**: first-run friction still exists even with docs; operators benefit from a command that creates minimum viable config files with safe defaults.

**Where**:
- `bin/linux-maint` (e.g., `init --minimal`)
- `etc/linux_maint/*.example`
- `docs/DARK_SITE.md`

**Acceptance**:
- One command creates minimum required files for a successful local run.
- Preserve existing `init` behavior and avoid destructive overwrites unless explicitly requested.

**Verify**:
- Add test covering idempotent re-run behavior.

---

## P2 — Security / hardening

### P2.1 [security] Harden temporary-file cleanup across monitors (NOT DONE)
**Why**: several monitors use `mktemp`; inconsistent cleanup can leave sensitive/large temp files behind after failures.

**Where**:
- `monitors/*.sh` with `mktemp` usage
- `tests/` (new targeted cleanup tests)

**Acceptance**:
- Add consistent `trap`-based cleanup for temp files in monitors that create them.
- Keep monitor behavior unchanged on success/failure semantics.

**Verify**:
- Add tests that simulate error paths and assert temp artifacts are removed.

---

### P2.2 [security] Expand log redaction coverage to structured auth fields (NOT DONE)
**Why**: support bundles/logs may include structured credentials (Bearer/JWT/session-like values) not fully covered by current patterns.

**Where**:
- `lib/linux_maint.sh`
- `tools/pack_logs.sh`
- `tests/log_redaction_test.sh`
- `tests/pack_logs_test.sh`

**Acceptance**:
- Add conservative redaction for common structured auth/token patterns.
- Preserve troubleshooting context (key names and surrounding non-sensitive text).

**Verify**:
- Extend tests with positive/negative fixtures for false-positive control.

---

## P3 — Signal quality / observability

### P3.1 [ops] Add top-N reason rollup in `linux-maint status` (NOT DONE)
**Why**: compact status is useful, but operators still need quick visibility into dominant failure reasons across monitors/hosts.

**Where**:
- `bin/linux-maint`
- `tests/status_contract_test.sh` and/or `tests/status_filters_test.sh`
- `docs/QUICK_REFERENCE.md`

**Acceptance**:
- Add optional reason rollup section (e.g., top 5 reasons with counts).
- Keep default output concise and backward compatible.

**Verify**:
- Add fixture-driven tests with mixed reason tokens.

---

### P3.2 [contract] Summary length + key-budget guardrails per monitor (NOT DONE)
**Why**: a global max-line lint exists, but per-monitor key growth can still regress readability and parser safety.

**Where**:
- `tests/summary_noise_lint.sh`
- `tests/summary_parse_safety_lint.py`
- `docs/reference.md`

**Acceptance**:
- Introduce guardrails for excessive key count and/or monitor-specific line budgets.
- Keep exceptions explicit and documented.

**Verify**:
- Add lint fixtures for pass/fail cases.

---

## P4 — DX / release polish

### P4.1 [dx] Add `make dev-check` target (DONE 2026-02-16)
**Why**: `tools/dev_check.sh` exists, but contributors expect a discoverable Make target aligned with existing workflow.

**Where**:
- `Makefile`
- `tests/` (optional Make-target test)
- `CONTRIBUTING.md`

**Acceptance**:
- Add `make dev-check` and include in `make help`.
- Keep current script behavior intact.

**Verify**:
- Run `make dev-check` in CI/local unprivileged mode.
- ✅ Implemented: added `dev-check` Make target and help text, wired to `tools/dev_check.sh`.
- ✅ Docs: CONTRIBUTING now includes `make dev-check` in the recommended local workflow.

---

### P4.2 [dx] CI matrix sanity for bash compatibility (NOT DONE)
**Why**: project relies on Bash features; testing one environment can miss distro/shell-version edge cases.

**Where**:
- `.github/workflows/*`
- `tests/smoke.sh`

**Acceptance**:
- Add lightweight matrix job(s) for at least two distro families or shell baselines.
- Keep runtime cost reasonable.

**Verify**:
- CI passes on all matrix entries with clear failure attribution.
