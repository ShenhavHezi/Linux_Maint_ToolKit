# linux_Maint_Scripts — ToDo List (roadmap)

This file is the project roadmap. Keep items small, testable, and tied to operator value.

Legend:
- Priority: P0 (must), P1 (high), P2 (medium), P3 (nice)
- Status: NOT DONE / DONE

Assumptions for this roadmap:
- Typical deployment is **single host** (not fleet) and often **dark-site / air-gapped**.
- Keep dependencies minimal; prefer optional features and best-effort behavior.

Rules:
- Pick ONE NOT DONE item per PR.
- After changes: update summarize.txt + run `python3 tools/gen_summarize.py`.
- Keep backward compatibility unless explicitly called out.

---

## P0 — Dark-site reliability & correctness (must not regress)

### P0.1 Make smoke exit codes explicit + document semantics (DONE)
**Why**: smoke is the first-line “does this install basically work?” check offline; exit codes must be understandable.

**Where**:
- `tests/smoke.sh`
- docs (`docs/reference.md` or `README.md`)

**Acceptance**:
- `tests/smoke.sh` uses named exit codes (constants) and prints a one-line reason on non-zero.
- Document exit code meanings (including the CI-seen `3`).

**Verify**:
- `bash -x ./tests/smoke.sh` still passes locally.

---

### P0.2 Wrapper ensures summary contract even on monitor crash (DONE)
**Why**: in single-host automation you still need *one* reliable summary line per monitor; crashes should not break parsing.

**Where**:
- `run_full_health_monitor.sh`

**Acceptance**:
- If a monitor exits without emitting any `monitor=` line, wrapper emits one with:
  - `status=UNKNOWN reason=early_exit`
- Preserve existing monitor output as-is.

**Verify**:
- Add a test with a fixture monitor that exits early.

---

### P0.3 Offline install verification: add `linux-maint verify-install` (DONE)
**Why**: dark-site installs need a deterministic “post-install checklist” command.

**Where**:
- `bin/linux-maint` (new subcommand)
- docs: `docs/DARK_SITE.md`

**Acceptance**:
- `linux-maint verify-install` checks:
  - required files exist (wrapper, lib, monitors)
  - systemd unit files present (if installed)
  - log/lock directories writable (or clear warnings)
  - prints version/build info
- Exits non-zero only on hard failures.

**Verify**:
- Test in repo mode + installed mode best-effort.

---

## P1 — Operator UX (single host)

### P1.1 Add `linux-maint pack-logs` (support bundle) (DONE)
**Why**: in air-gapped incidents, exporting a bundle for review/transfer is extremely useful.

**Where**:
- `bin/linux-maint` (new subcommand)
- new tool script under `tools/`

**Acceptance**:
- Produces a tar.gz containing:
  - latest full log + latest summary log + latest summary json (if exists)
  - `/etc/linux_maint/*` (redact secrets if present)
  - `BUILD_INFO`, `VERSION`
- Output path printed.

**Verify**:
- Test in repo mode using `.logs` fixtures.

---

### P1.2 Extend `linux-maint doctor` for common offline issues (DONE)
**Why**: dark-site users hit missing deps/misconfig and can’t “just google it”.

**Where**:
- `bin/linux-maint doctor`
- `docs/reference.md`

**Acceptance**:
- Doctor checks and prints actionable hints for:
  - missing `/etc/linux_maint/servers.txt` / empty targets
  - missing baselines (ports/users/configs) and how to generate
  - missing tools (curl/openssl/df/etc.) and distro-specific package hints (best-effort)

**Verify**:
- Add test that runs doctor in repo mode.

---

### P1.3 Add `linux-maint explain reason <token>` (DONE)
**Why**: makes `reason=` tokens self-serve.

**Where**:
- `bin/linux-maint`
- `docs/REASONS.md`

**Acceptance**:
- Prints matching section (or closest match) from `docs/REASONS.md`.

**Verify**:
- Test: `linux-maint explain reason ssh_unreachable` returns non-empty.

---

## P2 — Monitoring quality improvements (single host)

### P2.1 Service monitor: report failed units (systemd) (DONE)
**Why**: on single hosts, “something failed and got restarted” matters.

**Where**:
- `monitors/service_monitor.sh`

**Acceptance**:
- Optional config enables checking `systemctl --failed`.
- Summary includes `failed_units=<n>` and `reason=failed_units` when non-zero.

**Verify**:
- Test with fixture output (mock systemctl via PATH shim).

---

### P2.2 Disk trend monitor: inode trend (NOT DONE)
**Why**: inode exhaustion is common and looks like “disk full” failures.

**Where**:
- `monitors/disk_trend_monitor.sh`

**Acceptance**:
- Optional inode baseline/trend similar to space trend.
- Summary includes inode usage metrics.

**Verify**:
- Fixture-based test.

---

### P2.3 NTP drift monitor: chrony parsing robustness (NOT DONE)
**Why**: reduce UNKNOWN on chrony-based systems.

**Where**:
- `monitors/ntp_drift_monitor.sh`

**Acceptance**:
- Better detection and parsing of chrony outputs.

**Verify**:
- Tests with fixture strings.

---

## P3 — Release / CI / DX polish

### P3.1 Makefile target for offline artifacts: `make release-tarball` (DONE)
**Why**: standard entrypoint for maintainers; helpful even offline.

**Where**:
- `Makefile`

**Acceptance**:
- `make release-tarball` calls `tools/make_tarball.sh` and prints artifact paths.

**Verify**:
- Run target locally.

---

### P3.2 CI failure artifact upload (logs) (DONE)
**Why**: when CI fails, having logs as artifacts saves time.

**Where**:
- `.github/workflows/ci.yml`

**Acceptance**:
- On failure, upload `.logs/` and any produced summary artifacts.

**Verify**:
- Validate workflow yaml.

---

### P3.3 Git hooks helper: `./tools/install_githooks.sh` (NOT DONE)
**Why**: contributors forget to enable hooks; small QoL.

**Where**:
- `tools/`

**Acceptance**:
- Installs hooks from `.githooks/` into `.git/hooks/` idempotently.

**Verify**:
- Running twice is safe.

