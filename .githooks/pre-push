#!/usr/bin/env bash
set -euo pipefail

# 1) If this push includes code changes, require ToDoList.txt updates
# Compare local HEAD against upstream tracking branch if it exists.
upstream=$(git rev-parse --abbrev-ref --symbolic-full-name @{u} 2>/dev/null || true)
if [ -z "$upstream" ]; then
  exit 0
fi

changed=$(git diff --name-only "$upstream"..HEAD)
code_changed=$(echo "$changed" | grep -E '^(bin/|lib/|monitors/|tools/|packaging/|run_full_health_monitor\.sh$|install\.sh$|tests/)' || true)

if [ -n "$code_changed" ]; then
  meta_touched=$(echo "$changed" | grep -E '^(ToDoList\.txt)$' || true)
  if [ -z "$meta_touched" ]; then
    echo "ERROR: Code changes detected since $upstream, but ToDoList.txt was not updated." >&2
    echo "Please update ToDoList.txt and commit before pushing." >&2
    exit 1
  fi
fi
