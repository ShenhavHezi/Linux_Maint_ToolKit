name: Docs consistency

on:
  push:
    branches: [ "main" ]
  pull_request:

jobs:
  meta_doc_policy_advisory:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Advisory check for roadmap updates on code changes
        env:
          BASE_SHA: ${{ github.event.pull_request.base.sha }}
          HEAD_SHA: ${{ github.event.pull_request.head.sha }}
        run: |
          set -euo pipefail

          # files changed in the PR
          changed=$(git diff --name-only "$BASE_SHA".."$HEAD_SHA")

          echo "Changed files:" 
          echo "$changed"

          # Define what we consider "code" changes (broad but reasonable for this repo)
          code_changed=$(echo "$changed" | grep -E '^(bin/|lib/|monitors/|tools/|packaging/|run_full_health_monitor\.sh$|install\.sh$|tests/)' || true)

          if [ -z "$code_changed" ]; then
            echo "No code changes detected; meta-doc update not required."
            exit 0
          fi

          meta_touched=$(echo "$changed" | grep -E '^(ToDoList\.txt)$' || true)

          if [ -z "$meta_touched" ]; then
            echo "::warning::Code changes detected but ToDoList.txt was not updated. Update roadmap only when scope or priorities actually changed."
            exit 0
          fi

          echo "Roadmap updated in this PR: $meta_touched"
