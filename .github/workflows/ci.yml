name: CI

on:
  push:
  pull_request:

jobs:
  shellcheck-and-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck

      - name: ShellCheck
        run: |
          ./tools/shellcheck_wrapper.sh -x run_full_health_monitor.sh
          ./tools/shellcheck_wrapper.sh -x lib/linux_maint.sh
          ./tools/shellcheck_wrapper.sh -x bin/linux-maint
          ./tools/shellcheck_wrapper.sh -x monitors/*.sh
          ./tools/shellcheck_wrapper.sh -x tests/*.sh
          ./tools/shellcheck_wrapper.sh -x tools/*.sh


      - name: Summary contract test (unprivileged)
        run: |
          mkdir -p .logs
          ./tests/summary_contract.sh

      - name: Summary contract lint (reason/status/monitor= lines)
        run: |
          ./tests/summary_contract_lint.sh

      - name: Smoke test (best-effort)
        run: |
          chmod +x tests/smoke.sh
          ./tests/smoke.sh || true

  bash-compat-matrix:
    name: Bash compatibility (${{ matrix.distro }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - distro: ubuntu-24.04
            image: ubuntu:24.04
            pkg_install: apt-get update && apt-get install -y bash coreutils findutils gawk grep sed tar gzip python3 ca-certificates openssl iproute2
          - distro: debian-12
            image: debian:12
            pkg_install: apt-get update && apt-get install -y bash coreutils findutils gawk grep sed tar gzip python3 ca-certificates openssl iproute2
    container:
      image: ${{ matrix.image }}
    steps:
      - name: Install runtime dependencies
        shell: bash
        run: |
          set -euo pipefail
          export DEBIAN_FRONTEND=noninteractive
          bash -lc "${{ matrix.pkg_install }}"

      - name: Checkout
        uses: actions/checkout@v4

      - name: Bash version
        run: |
          bash --version | head -n 1

      - name: Smoke test (matrix)
        run: |
          chmod +x tests/smoke.sh
          rc=0
          SMOKE_PROFILE=compat ./tests/smoke.sh || rc=$?
          if [ "$rc" -ne 0 ] && [ "$rc" -ne 3 ]; then
            echo "smoke failed with rc=$rc"
            exit "$rc"
          fi
          echo "smoke matrix ok (rc=$rc)"

  build-rpm-rocky9:
    runs-on: ubuntu-latest
    container:
      image: rockylinux:9
    steps:
      - name: Install build tools
        run: |
          dnf -y update
          dnf -y install rpm-build rsync tar systemd-rpm-macros python3

      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate BUILD_INFO (CI)
        run: |
          ./tools/gen_build_info.sh
          echo "=== BUILD_INFO ==="
          cat BUILD_INFO


      - name: Build RPM
        run: |
          ./packaging/rpm/build_rpm.sh
          echo "=== RPM query info (rpm -qp --info) ==="
          rpm -qp --info /tmp/linux-maint-rpmbuild/RPMS/noarch/*.rpm || true

      - name: Install RPM (smoke)
        run: |
          dnf -y install /tmp/linux-maint-rpmbuild/RPMS/noarch/*.rpm
          linux-maint --help | head -n 40
          linux-maint version || true
          test -f /usr/share/linux_Maint_Scripts/docs/REASONS.md
          linux-maint explain reason ssh_unreachable
          # systemd checks (may be limited inside container, but unit files should exist)
          test -f /usr/lib/systemd/system/linux-maint.timer
          test -f /usr/lib/systemd/system/linux-maint.service
          systemctl is-enabled linux-maint.timer || true
          systemctl is-active linux-maint.timer || true
          linux-maint doctor || true
          # basic run (best-effort; may fail in container, should not hang)
          timeout 60s /usr/sbin/run_full_health_monitor.sh || true
          test -f /var/log/health/last_status_full || true



      - name: Upload smoke logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-logs-rocky9
          path: |
            /var/log/health/**
            /etc/linux_maint/**
            /var/lib/linux_maint/**
          if-no-files-found: ignore

      - name: Upload RPM artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-maint-rpm-rocky9
          path: /tmp/linux-maint-rpmbuild/RPMS/**/*.rpm
