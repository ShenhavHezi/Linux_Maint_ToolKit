name: CI

on:
  push:
  pull_request:

jobs:
  shellcheck-and-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck

      - name: ShellCheck
        run: |
          ./tools/shellcheck_wrapper.sh -x run_full_health_monitor.sh
          ./tools/shellcheck_wrapper.sh -x lib/linux_maint.sh
          ./tools/shellcheck_wrapper.sh -x bin/linux-maint
          ./tools/shellcheck_wrapper.sh -x monitors/*.sh
          ./tools/shellcheck_wrapper.sh -x tests/*.sh
          ./tools/shellcheck_wrapper.sh -x tools/*.sh

      - name: Docs link check
        run: |
          ./tools/docs_link_check.sh



      - name: Secret scan (high-confidence, allowlisted)
        run: |
          ./tools/secret_scan.sh

      - name: Summary contract test (unprivileged)
        run: |
          mkdir -p .logs
          ./tests/summary_contract.sh

      - name: Summary contract lint (reason/status/monitor= lines)
        run: |
          ./tests/summary_contract_lint.sh

      - name: Smoke test (best-effort)
        run: |
          chmod +x tests/smoke.sh
          ./tests/smoke.sh || true

  bash-compat-matrix:
    name: Bash compatibility (${{ matrix.distro }})
    runs-on: ubuntu-latest
    env:
      ACTIONS_ALLOW_USE_UNSECURE_NODE_VERSION: true
    continue-on-error: ${{ matrix.allow_failure || false }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - distro: ubuntu-24.04
            image: ubuntu:24.04
            pkg_install: apt-get update && apt-get install -y bash coreutils findutils gawk grep sed tar gzip python3 ca-certificates openssl iproute2 git
            allow_failure: false
            legacy_checkout: false
          - distro: debian-12
            image: debian:12
            pkg_install: apt-get update && apt-get install -y bash coreutils findutils gawk grep sed tar gzip python3 ca-certificates openssl iproute2 git
            allow_failure: false
            legacy_checkout: false
          - distro: ubuntu-18.04
            image: ubuntu:18.04
            pkg_install: apt-get update && apt-get install -y bash coreutils findutils gawk grep sed tar gzip python3 ca-certificates openssl iproute2 git
            allow_failure: false
            legacy_checkout: true
          - distro: centos-7
            image: centos:7
            pkg_install: yum -y --setopt=skip_if_unavailable=true install bash coreutils findutils gawk grep sed tar gzip openssl iproute git || true; yum -y --setopt=skip_if_unavailable=true install python3 || yum -y --setopt=skip_if_unavailable=true install python36 || true
            allow_failure: true
            legacy_checkout: true
    container:
      image: ${{ matrix.image }}
    steps:
      - name: Install runtime dependencies
        shell: bash
        run: |
          set -euo pipefail
          export DEBIAN_FRONTEND=noninteractive
          bash -lc "${{ matrix.pkg_install }}"

      - name: Compat readiness
        id: compat_ready
        if: ${{ matrix.legacy_checkout }}
        shell: bash
        run: |
          if command -v git >/dev/null 2>&1; then
            echo "ready=1" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          echo "ready=0" >> "$GITHUB_OUTPUT"
          echo "skip: git unavailable after package install"

      - name: Checkout (actions)
        if: ${{ !matrix.legacy_checkout }}
        uses: actions/checkout@v3

      - name: Checkout (legacy manual)
        if: ${{ matrix.legacy_checkout && steps.compat_ready.outputs.ready == '1' }}
        shell: bash
        run: |
          set -euo pipefail
          if ! command -v git >/dev/null 2>&1; then
            if command -v apt-get >/dev/null 2>&1; then
              apt-get update
              apt-get install -y git
            elif command -v yum >/dev/null 2>&1; then
              yum -y install git
            fi
          fi
          rm -rf ./*
          git init .
          git config --global --add safe.directory "$(pwd)"
          git remote add origin "https://x-access-token:${{ github.token }}@github.com/${{ github.repository }}.git"
          git fetch --no-tags --prune --depth=1 origin "${GITHUB_SHA}"
          git checkout --force FETCH_HEAD

      - name: Bash version
        if: ${{ !matrix.legacy_checkout || steps.compat_ready.outputs.ready == '1' }}
        run: |
          bash --version | head -n 1

      - name: Smoke test (matrix)
        if: ${{ !matrix.legacy_checkout || steps.compat_ready.outputs.ready == '1' }}
        run: |
          chmod +x tests/smoke.sh
          rc=0
          SMOKE_PROFILE=compat ./tests/smoke.sh || rc=$?
          if [ "$rc" -ne 0 ] && [ "$rc" -ne 3 ]; then
            echo "smoke failed with rc=$rc"
            exit "$rc"
          fi
          echo "smoke matrix ok (rc=$rc)"

  build-rpm-rocky9:
    runs-on: ubuntu-latest
    container:
      image: rockylinux:9
    steps:
      - name: Install build tools
        run: |
          dnf -y update
          dnf -y install rpm-build rsync tar systemd-rpm-macros python3

      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate BUILD_INFO (CI)
        run: |
          ./tools/gen_build_info.sh
          echo "=== BUILD_INFO ==="
          cat BUILD_INFO


      - name: Build RPM
        run: |
          ./packaging/rpm/build_rpm.sh
          echo "=== RPM query info (rpm -qp --info) ==="
          rpm -qp --info /tmp/linux-maint-rpmbuild/RPMS/noarch/*.rpm || true

      - name: Install RPM (smoke)
        run: |
          dnf -y install /tmp/linux-maint-rpmbuild/RPMS/noarch/*.rpm
          linux-maint --help | head -n 40
          linux-maint version || true
          test -f /usr/share/Linux_Maint_ToolKit/docs/REASONS.md
          linux-maint explain reason ssh_unreachable
          # systemd checks (may be limited inside container, but unit files should exist)
          test -f /usr/lib/systemd/system/linux-maint.timer
          test -f /usr/lib/systemd/system/linux-maint.service
          systemctl is-enabled linux-maint.timer || true
          systemctl is-active linux-maint.timer || true
          linux-maint doctor || true
          # basic run (best-effort; may fail in container, should not hang)
          timeout 60s /usr/sbin/run_full_health_monitor.sh || true
          test -f /var/log/health/last_status_full || true



      - name: Upload smoke logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-logs-rocky9
          path: |
            /var/log/health/**
            /etc/linux_maint/**
            /var/lib/linux_maint/**
          if-no-files-found: ignore

      - name: Upload RPM artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-maint-rpm-rocky9
          path: /tmp/linux-maint-rpmbuild/RPMS/**/*.rpm
