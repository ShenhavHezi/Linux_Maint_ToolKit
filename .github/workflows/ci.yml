name: CI

on:
  push:
  pull_request:

jobs:
  shellcheck-and-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck

      - name: ShellCheck
        run: |
          ./tools/shellcheck_wrapper.sh -x run_full_health_monitor.sh
          ./tools/shellcheck_wrapper.sh -x lib/linux_maint.sh
          ./tools/shellcheck_wrapper.sh -x bin/linux-maint
          ./tools/shellcheck_wrapper.sh -x monitors/*.sh
          ./tools/shellcheck_wrapper.sh -x tests/*.sh
          ./tools/shellcheck_wrapper.sh -x tools/*.sh


      - name: Summary contract test (unprivileged)
        run: |
          mkdir -p .logs
          ./tests/summary_contract.sh

      - name: Summary contract lint (reason/status/monitor= lines)
        run: |
          ./tests/summary_contract_lint.sh

      - name: Smoke test (best-effort)
        run: |
          chmod +x tests/smoke.sh
          ./tests/smoke.sh || true

  build-rpm-rocky9:
    runs-on: ubuntu-latest
    container:
      image: rockylinux:9
    steps:
      - name: Install build tools
        run: |
          dnf -y update
          dnf -y install rpm-build rsync tar systemd-rpm-macros python3

      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate BUILD_INFO (CI)
        run: |
          ./tools/gen_build_info.sh
          echo "=== BUILD_INFO ==="
          cat BUILD_INFO


      - name: Build RPM
        run: |
          ./packaging/rpm/build_rpm.sh
          echo "=== RPM query info (rpm -qp --info) ==="
          rpm -qp --info /tmp/linux-maint-rpmbuild/RPMS/noarch/*.rpm || true

      - name: Install RPM (smoke)
        run: |
          dnf -y install /tmp/linux-maint-rpmbuild/RPMS/noarch/*.rpm
          linux-maint --help | head -n 40
          linux-maint version || true
          # systemd checks (may be limited inside container, but unit files should exist)
          test -f /usr/lib/systemd/system/linux-maint.timer
          test -f /usr/lib/systemd/system/linux-maint.service
          systemctl is-enabled linux-maint.timer || true
          systemctl is-active linux-maint.timer || true
          linux-maint doctor || true
          # basic run (best-effort; may fail in container, should not hang)
          timeout 60s /usr/sbin/run_full_health_monitor.sh || true
          test -f /var/log/health/last_status_full || true

      - name: Upload RPM artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-maint-rpm-rocky9
          path: /tmp/linux-maint-rpmbuild/RPMS/**/*.rpm
