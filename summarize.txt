# linux_Maint_Scripts — Summary (linux-maint)

> Note: `ToDoList.txt` is the active planning file.
> This summary is maintained for high-level capability snapshots only and is updated less frequently to reduce merge conflicts.

## What this project is

**linux-maint** is a Bash-based maintenance and health-monitoring toolkit for Linux.
It runs a suite of small “monitors” and produces both:

- **Human-readable logs** for troubleshooting
- **Machine-parseable artifacts** (summary line protocol + JSON) for automation, alerting, and reporting

It supports:

- **Repo mode**: run from the git checkout (useful for development/CI)
- **Installed mode**: install to `/usr/local` with stable paths and optional systemd timer/logrotate integration
- **Local-only and fleet orchestration**: CLI/wrapper support targeting multiple hosts over SSH (config-driven)

## High-level architecture

- `run_full_health_monitor.sh` (wrapper)
  - Runs monitor scripts from `monitors/` (installed mode uses copies under `/usr/local/libexec/linux_maint/`).
  - Enforces a **timeout per monitor** (uses `timeout` when available; controlled by `MONITOR_TIMEOUT_SECS`).
  - Enforces the **summary contract**:
    - if a monitor exits non-zero but emits no `monitor=` summary line, wrapper emits:
      - `status=UNKNOWN reason=no_summary_emitted`
  - Computes overall result based on the **worst** monitor exit code.

- `bin/linux-maint` (CLI)
  - Entry point for operators.
  - Handles repo vs installed mode.
  - Provides convenience commands: `run`, `status`, `logs`, `doctor`, `init`, `preflight`, `validate`, `install`, `uninstall`.

- `lib/linux_maint.sh` + `lib/linux_maint_conf.sh`
  - Shared library and configuration loader (including `/etc/linux_maint/linux-maint.conf` and `/etc/linux_maint/conf.d/*`).

## Primary CLI commands (operator-facing)

- `linux-maint run`
  - Executes the wrapper and writes artifacts.
  - Supports fleet flags such as `--group`, `--hosts`, `--exclude`, `--parallel`, `--shuffle`, `--limit`, `--dry-run`.

- `linux-maint status`
  - Shows last run metadata (from `last_status_full`) plus a **compact admin summary** by default:
    - totals by severity (`CRIT/WARN/UNKNOWN/SKIP/OK`)
    - severity-sorted minimal problems list (`STATUS monitor [reason=...]`)
  - Flags:
    - `--verbose` (show raw summary lines)
    - `--problems N` (default 20, max 100)
    - `--only OK|WARN|CRIT|UNKNOWN|SKIP`

- `linux-maint logs [N]` — tail latest wrapper log
- `linux-maint doctor` — diagnostics (paths, timers, permissions)
- `linux-maint init` — create initial config under `/etc/linux_maint`
- `linux-maint preflight` — preflight checks
- `linux-maint validate` — validate configuration
- `linux-maint install|uninstall` — wrapper around `install.sh`

## Exit codes

The project standard is:
- `0` = OK
- `1` = WARN
- `2` = CRIT
- `3` = UNKNOWN/ERROR

Wrapper returns the worst exit code across all executed monitors.

## Output artifacts

Artifacts are intended to be stable and automation-friendly.

Installed mode (default locations):

- Full run log:
  - `/var/log/health/full_health_monitor_<timestamp>.log`
  - symlink: `/var/log/health/full_health_monitor_latest.log`

- Summary log (one line per monitor):
  - `/var/log/health/full_health_monitor_summary_<timestamp>.log`
  - symlink: `/var/log/health/full_health_monitor_summary_latest.log`

- Summary JSON:
  - `/var/log/health/full_health_monitor_summary_<timestamp>.json`
  - symlink: `/var/log/health/full_health_monitor_summary_latest.json`

- Last status file:
  - `/var/log/health/last_status_full` (timestamp/host/overall/exit_code/logfile)

- Optional Prometheus textfile (node_exporter textfile collector):
  - `/var/lib/node_exporter/textfile_collector/linux_maint.prom`

Repo mode writes equivalent artifacts under `./.logs/`.

## Summary contract (line protocol)

Each monitor should emit at least one summary line:

```text
monitor=<name> host=<target> status=<OK|WARN|CRIT|UNKNOWN|SKIP> node=<runner> key=value...
```

Notes:
- Non-OK should ideally include `reason=<token>` (see `docs/REASONS.md`).
- Wrapper emits `SKIP` summary lines for monitors gated by missing optional config/baselines.

## Included monitors (current)

Located in `monitors/`:

<!-- AUTOGEN:MONITORS:START -->
- `backup_check`
- `cert_monitor`
- `config_drift_monitor`
- `config_validate`
- `disk_trend_monitor`
- `health_monitor`
- `inode_monitor`
- `inventory_export`
- `kernel_events_monitor`
- `log_spike_monitor`
- `network_monitor`
- `nfs_mount_monitor`
- `ntp_drift_monitor`
- `patch_monitor`
- `ports_baseline_monitor`
- `preflight_check`
- `resource_monitor`
- `service_monitor`
- `storage_health_monitor`
- `user_monitor`
<!-- AUTOGEN:MONITORS:END -->

## Configuration

Primary configuration lives under `/etc/linux_maint/`.

Notable config features:
- Main config: `/etc/linux_maint/linux-maint.conf`
- Optional drop-ins: `/etc/linux_maint/conf.d/*.conf`
- Additional lists/baselines under `/etc/linux_maint/` (hosts, excluded, services, ports baseline, certs, users/sudoers baselines, etc.)

Some monitors are gated by optional config/baseline files; wrapper emits `status=SKIP reason=missing:<path>`.

## Packaging / installation


Installer flags (from `install.sh`):

<!-- AUTOGEN:INSTALL_FLAGS:START -->
- `--prefix`
- `--purge`
- `--uninstall`
- `--user`
- `--with-logrotate`
- `--with-timer`
- `--with-user`
<!-- AUTOGEN:INSTALL_FLAGS:END -->

RPM packaging exists under `packaging/rpm/` (spec + systemd service/timer files).


## Tooling

- `tools/make_tarball.sh` — create an offline tarball
- `tools/gen_build_info.sh` — build metadata
- `tools/summary_diff.py` — compare/parse summary output (used by installed mode)
- `tools/update_readme_defaults.py` — keep docs defaults in sync

## Documentation

- `README.md` — overview + quickstart
- `docs/QUICK_REFERENCE.md` — operator cheat sheet
- `docs/reference.md` — full reference (monitors, knobs, offline/air-gapped, install)
- `docs/DARK_SITE.md` — offline/air-gapped notes
- `docs/REASONS.md` — reason tokens contract
- `ToDoList.txt` — prioritized actionable backlog

## 2026-02-09
- wrapper: add optional per-monitor timeout overrides via `MONITOR_TIMEOUTS_FILE`/`monitor_timeouts.conf` (and emit `reason=timeout` on wrapper timeout).
- tests: add `per_monitor_timeout_override_test.sh` and wire into smoke.
- monitors: ports_baseline_monitor now respects `LM_CFG_DIR` for baselines/allowlist paths (improves unprivileged testability without changing default behavior).

## 2026-02-09
- tests: add `summary_noise_lint.sh` guardrail to keep `monitor=` summary lines short (default max 220 chars), and wire it into smoke.

## 2026-02-09
- preflight_check: reduce summary noise by keeping only routing-relevant counts in `monitor=` lines; moved extra counters into full log.

## 2026-02-10
- tests: fix `monitor_summary_emission_test.sh` to run monitors with a writable `LM_CFG_DIR` (default `/tmp/linux_maint_cfg`) so baseline-based monitors can emit `monitor=` lines in CI.
- docs/dev: add `Makefile` (lint/test convenience) and `CONTRIBUTING.md` (monitor contract + workflow).
- ci: run ShellCheck with repo `.shellcheckrc` (stop excluding SC2086 globally in workflow).
- shellcheck: fix/annotate `user_monitor.sh` so CI passes without globally excluding SC2086.
- shellcheck: align CI with `.shellcheckrc` and fix remaining SC2086 hits in summary emission for patch/storage/ports/user monitors.
- shellcheck: quiet SC2317/SC2155 false-positives in backup_check and ntp_drift_monitor now that CI no longer excludes warnings globally.
## 2026-02-10
- shellcheck: quote summary key/value fields in disk_trend_monitor and kernel_events_monitor to satisfy SC2086 (no global exclude).
## 2026-02-10
- ci/shellcheck: keep CI excludes in sync with .shellcheckrc; fix accidental escaped quotes that triggered SC2086 in backup_check/inode_monitor/config_drift.
## 2026-02-10
- shellcheck: stop excluding SC2016/SC2162 globally; disable locally in scripts that intentionally build remote shell snippets or use read without -r.
## 2026-02-10
- ci: enforce meta-doc updates on PRs (require ToDoList.txt or summarize.txt when code changes), and fix diff range variable in docs_consistency workflow.
## 2026-02-10
- docs: replace ToDoList.txt with a refreshed prioritized roadmap (P0–P5) covering CI correctness, security hardening, operability, and new monitors.
## 2026-02-10
- tooling/ci: add `tools/shellcheck_wrapper.sh` and route CI/Makefile/pre-commit through it so `.shellcheckrc` is the single ShellCheck exclude source.
## 2026-02-10
- monitors: quote variable key=value fields in `lm_summary` across multiple monitors to prevent SC2086 and keep summary parsing robust.
## 2026-02-10
- tests: add `summary_parse_safety_lint` to ensure `monitor=` lines remain stable key=value tokens (required keys, no dup keys, no whitespace-in-values), and wire it into smoke.
## 2026-02-10
- docs: clarify SSH defaults and host key/known_hosts policy for LM_SSH_OPTS (fleet mode) in docs/reference.md.
## 2026-02-10
- lib: add optional log redaction via LM_REDACT_LOGS to mask common secret patterns; tests: add log_redaction_test and wire into smoke.
## 2026-02-10
- monitors: add RETURN traps to clean up mktemp files in config_drift_monitor and ports_baseline_monitor helper functions (reduce /tmp clutter; no behavior change).
## 2026-02-10
- docs: document existing `linux-maint diff` command in README and docs/QUICK_REFERENCE.md; verified installer/RPM include summary_diff.py for installed-mode diff.
## 2026-02-10
- wrapper: keep LM_STATE_DIR default as /tmp (repo-mode safe), but persist linux-maint diff state under /var/lib/linux_maint by default; document diff state location.
## 2026-02-10
- cli: improve `linux-maint diff` messaging and print the resolved diff state paths (diff_state_dir/diff_prev/diff_cur) for easier troubleshooting.
## 2026-02-10
- docs/roadmap: mark P2.1 linux-maint diff as DONE (command existed; now documented and installed-mode diff state fixed).
## 2026-02-10
- cli: add `linux-maint status --last N` to show totals for the last N summary artifacts (best-effort) in repo and installed modes.
## 2026-02-10
- cli: define REPO_SUMMARY_LATEST and INST_SUMMARY_LATEST paths to avoid unbound var in status/diff on CI (set -u).

[2026-02-11] fix: improve Prometheus textfile output (dedupe monitor series + add status counts)
- Why: Prometheus rejects duplicate labelsets; add dashboard-friendly status counts.
- Change: wrapper Prometheus writer dedupes by monitor+host keeping worst status; exports linux_maint_monitor_status_count by status; added tests/prom_textfile_output_test.sh and wired into smoke.

[2026-02-11] feat: add resource_monitor (CPU/mem/swap pressure)
- Why: resource pressure is a common root cause; provide clear WARN/CRIT thresholds.
- Change: new monitors/resource_monitor.sh with reasons high_load/high_mem/swap_thrash; added basic test and wired into wrapper + smoke.

[2026-02-11] feat: add log_spike_monitor (journald/syslog error-rate thresholds)
- Why: spikes in kernel/service errors often precede outages.
- Change: new monitors/log_spike_monitor.sh with fixture-driven tests; wired into wrapper + smoke; documented reasons log_spike_warn/log_spike_crit/missing_log_source.

[2026-02-11] feat: cert_monitor directory scan option (offline cert file expiry)
- Why: cert sprawl is common; scanning a directory reduces manual config.
- Change: cert_monitor supports CERTS_SCAN_DIR with ignore patterns and extension filtering; added generated cert fixture test and wired into smoke.

[2026-02-12] fix: log_spike_monitor tolerate 0 grep matches under set -e
- Why: grep exits 1 on 0 matches, causing false failures in CI/smoke.
- Change: treat 0 matches as OK when counting errors (|| true), preserving WARN/CRIT behavior.

[2026-02-12] chore: add tools/dev_check.sh
- Why: provide one command for contributors to regenerate summarize, lint, and run smoke.
- Change: new tools/dev_check.sh runs gen_summarize.py, shellcheck_wrapper, and tests/smoke.sh.

[2026-02-12] chore: systemd unit hardening (best-effort)
- Why: reduce blast radius for root-running automation.
- Change: add conservative hardening directives to linux-maint.service (installer template + RPM unit).
- Notes: allow required writes via ReadWritePaths for /var/log, /var/log/health, /var/lib/linux_maint, /var/lock, /tmp.

2026-02-12
- CI: make smoke test best-effort (non-blocking) to avoid CI failures due to environment-dependent exit codes.
- Dark-site/offline: improve tarball release flow by generating dist/SHA256SUMS automatically and aligning docs with actual artifact naming and verification steps.

2026-02-12
- Smoke test: standardized exit codes (0=ok, 3=ok but optional sudo-gated checks skipped) and documented semantics in docs/reference.md.

2026-02-12
- Wrapper hardening: if a monitor fails without emitting any `monitor=` summary line, the wrapper now synthesizes a single `status=UNKNOWN reason=early_exit` summary line for contract safety.

2026-02-12
- Added `linux-maint verify-install` for dark-site post-install validation (checks layout/files, basic config presence, and best-effort systemd status).

2026-02-12
- Added `linux-maint pack-logs` to generate a redacted support bundle (tar.gz) containing latest logs/summaries, config snapshot, and build metadata for dark-site incident handoff.

2026-02-12
- Improved `linux-maint doctor` for dark-site/single-host use: config sanity checks, monitor skip-gate hints, dependency hints, and clearer next actions.

2026-02-12
- Added `linux-maint explain reason <token>` (and `explain status <S>`) for quick on-call decoding of reason/status values using docs/REASONS.md.

2026-02-12
- Installer now copies operator docs (docs/*.md) into /usr/local/share/linux_Maint_Scripts/docs so installed-mode `linux-maint explain` works in dark-site environments.

2026-02-12
- RPM packaging: ship operator docs under /usr/share/linux_Maint_Scripts/docs so installed-mode `linux-maint explain` works offline.

[2026-02-12] ci: upload rocky9 smoke logs on failure
- Why: when the RPM smoke step fails, having /var/log/health and config/state snapshots as artifacts speeds debugging.
- Change: added actions/upload-artifact step gated by if: failure() to upload /var/log/health, /etc/linux_maint, /var/lib/linux_maint (if present).

2026-02-13
- Makefile: add release-tarball target (calls tools/make_tarball.sh) for maintainer/offline artifact creation.

2026-02-13
- service_monitor: optional systemd failed-units check (LM_SERVICE_CHECK_FAILED_UNITS=1) emits failed_units=<n> and reason=failed_units when non-zero.
- tests: add service_monitor_failed_units_test.sh and wire into smoke.

2026-02-13
- disk_trend_monitor: add optional inode trend state collection (LM_DISK_TREND_INODES=1) into separate per-host state file (<host>.inodes.csv) to preserve existing disk trend state format.
- tests: add disk_trend_inode_trend_test.sh (PATH shim for df/ssh) and wire into smoke.

2026-02-13
- ntp_drift_monitor: harden chrony parsing by falling back to Last offset / RMS offset when System time is missing, reducing UNKNOWN/WARN noise on chrony-based systems.
- tests: add ntp_chrony_parsing_variants_test.sh (fixture strings) and wire into smoke.

2026-02-13
- tools: add install_githooks.sh to install .githooks/* into .git/hooks/ idempotently (backs up existing hooks once).

2026-02-13
- docs: add docs/INDEX.md and link it (and key docs) prominently from README for GitHub readability.

## 2026-02-15
- cli/status: add `--host PATTERN` and `--monitor PATTERN` filters for compact, verbose, and JSON status output.
- cli/status: include `host=...` context in compact problem lines and JSON problem entries to improve triage/automation readability.
- tests: add `tests/status_filters_test.sh` regression coverage for filtered compact + JSON outputs.
- docs: update `README.md`, `docs/reference.md`, and `docs/QUICK_REFERENCE.md` with new status filtering examples/flags.

## 2026-02-15
- wrapper: make config-gate SKIP checks use `CFG_DIR` (from `LM_CFG_DIR`) instead of hardcoded `/etc/linux_maint`, improving repo/unprivileged and dark-site runs.
- wrapper: auto-SKIP `network_monitor` when `network_targets.txt` is missing/empty, reducing noise in dark-site environments.
- tests: add `tests/wrapper_network_targets_skip_test.sh` to validate network monitor SKIP behavior with custom `LM_CFG_DIR`.
- docs: update dark-site/reference/README guidance for optional `network_targets.txt` behavior.
- tests: fix `wrapper_network_targets_skip_test.sh` to avoid `ls` parsing (SC2012) by using `find ... | sort | tail -n 1` for latest log selection.

- tests/contract: fix `tests/summary_contract.sh` for unprivileged CI by using writable `LM_CFG_DIR` + localhost hostlist; restores stable `monitor=` emission checks.
- disk_trend_monitor: fix localhost collection invocation to avoid nested `bash -lc` mis-parsing, eliminating noisy awk warnings/hangs and restoring summary output in contract tests.

## 2026-02-15
- docs/process: cleaned accidental merge-noise lines from `summarize.txt` and kept roadmap authority in `ToDoList.txt` to reduce repeated conflict churn.

## 2026-02-15
- dark-site: add optional `LM_DARK_SITE=true` wrapper profile that sets conservative defaults (`LM_LOCAL_ONLY=true`, `LM_NOTIFY_ONLY_ON_CHANGE=1`, `MONITOR_TIMEOUT_SECS=300`) while keeping explicit overrides intact.
- tests: add `tests/wrapper_dark_site_profile_test.sh` to validate default behavior and override behavior.
- docs: document `LM_DARK_SITE` in `README.md`, `docs/reference.md`, `docs/DARK_SITE.md`, and `etc/linux_maint/linux-maint.conf.example`.
- tests: fix ShellCheck SC2068 in `tests/wrapper_dark_site_profile_test.sh` by changing unquoted `env $@` to safe quoted forwarding `env "$@"`.
- dark-site docs: add day-0 bootstrap checklist (minimum required files + expected first-run SKIP statuses) and link it from README for quicker offline onboarding.
- cli: add `linux-maint deps` command to print per-monitor required/optional command manifest with local availability counters (offline-friendly); docs/tests updated.
- security: strengthen `tools/pack_logs.sh` redaction for password/token/api_key/secret/authorization patterns and extend `tests/pack_logs_test.sh` to assert secret removal plus placeholder preservation.
- tests: fix ShellCheck SC2251 in `tests/pack_logs_test.sh` by replacing negated standalone `grep` checks with explicit assertion helper failures.
- ssh policy: document `LM_SSH_OPTS` guardrails (accepted/rejected patterns + safe examples) and add `tests/ssh_opts_validation_test.sh` coverage for safe/unsafe strings with expected rc=2 on unsafe input.
- tests: fix ShellCheck SC2016 in `tests/ssh_opts_validation_test.sh` by expressing unsafe command-substitution fixtures as escaped literals in double quotes.
- status: add `--match-mode contains|exact|regex` for `--host`/`--monitor` filters across compact/verbose/JSON status paths; include test coverage for exact/regex matching and invalid-regex exit behavior.
- dx: add `make install-githooks` target (listed in `make help`) and test idempotency with `tests/install_githooks_make_target_test.sh`.

## 2026-02-16
- preflight_check: remove per-dependency `lm_require_cmd` summary emissions so preflight now emits a single actionable summary line per run; move dependency detail lists to `LM_LOGFILE`.
- tests: extend `tests/preflight_missing_ssh_test.sh` to assert single-line summary output and set `LINUX_MAINT_LIB` explicitly for stable repo-mode execution.

## 2026-02-16
- disk_trend_monitor: when `LM_DISK_TREND_INODES=1|true`, summary output now includes compact inode rollup keys (`inode_mounts`, `inode_warn`, `inode_crit`) to surface inode pressure signal without expanding per-mount summary noise.
- tests: extend `tests/disk_trend_inode_trend_test.sh` to assert inode rollup keys in the monitor summary output.

## 2026-02-16
- docs/reference: document `LM_DISK_TREND_INODES` toggle/default and the inode rollup summary keys emitted by `disk_trend_monitor` (`inode_mounts`, `inode_warn`, `inode_crit`) to keep operator contract docs aligned with current monitor output.

## 2026-02-16
- disk_trend_monitor: make trend state path resolution deterministic with precedence `STATE_BASE` → `${LM_STATE_DIR}/linux_maint/disk_trend` → `/var/lib/linux_maint/disk_trend`; if unresolved path is not writable, monitor falls back to `/tmp/linux_maint/disk_trend` and logs a warning.
- tests/docs: tighten inode trend test to assert deterministic `LM_STATE_DIR` artifact path and document the state path precedence/fallback in `docs/reference.md`.

## 2026-02-16
- cli: add `linux-maint doctor --json` for machine-readable diagnostics in dark-site automation workflows, including config presence, monitor skip-gates, dependency availability, writable location checks, and recommended next actions.
- tests/docs: add `tests/doctor_json_test.sh` (wired into smoke) and document `doctor --json` usage in README and quick reference.

## 2026-02-16
- contract: standardize non-OK summary `reason=` coverage across key monitors, including disk trend, NFS, kernel events, inode, config drift, ports baseline, user, health, and backup summary paths.
- tests: add `tests/nfs_reason_unreachable_test.sh` and wire it into `tests/smoke.sh` to assert CRIT unreachable NFS paths emit `reason=ssh_unreachable`.
