# linux_Maint_Scripts — Summary (linux-maint)

## What this project is

**linux-maint** is a Bash-based maintenance and health-monitoring toolkit for Linux.
It runs a suite of small “monitors” and produces both:

- **Human-readable logs** for troubleshooting
- **Machine-parseable artifacts** (summary line protocol + JSON) for automation, alerting, and reporting

It supports:

- **Repo mode**: run from the git checkout (useful for development/CI)
- **Installed mode**: install to `/usr/local` with stable paths and optional systemd timer/logrotate integration
- **Local-only and fleet orchestration**: CLI/wrapper support targeting multiple hosts over SSH (config-driven)

## High-level architecture

- `run_full_health_monitor.sh` (wrapper)
  - Runs monitor scripts from `monitors/` (installed mode uses copies under `/usr/local/libexec/linux_maint/`).
  - Enforces a **timeout per monitor** (uses `timeout` when available; controlled by `MONITOR_TIMEOUT_SECS`).
  - Enforces the **summary contract**:
    - if a monitor exits non-zero but emits no `monitor=` summary line, wrapper emits:
      - `status=UNKNOWN reason=no_summary_emitted`
  - Computes overall result based on the **worst** monitor exit code.

- `bin/linux-maint` (CLI)
  - Entry point for operators.
  - Handles repo vs installed mode.
  - Provides convenience commands: `run`, `status`, `logs`, `doctor`, `init`, `preflight`, `validate`, `install`, `uninstall`.

- `lib/linux_maint.sh` + `lib/linux_maint_conf.sh`
  - Shared library and configuration loader (including `/etc/linux_maint/linux-maint.conf` and `/etc/linux_maint/conf.d/*`).

## Primary CLI commands (operator-facing)

- `linux-maint run`
  - Executes the wrapper and writes artifacts.
  - Supports fleet flags such as `--group`, `--hosts`, `--exclude`, `--parallel`, `--shuffle`, `--limit`, `--dry-run`.

- `linux-maint status`
  - Shows last run metadata (from `last_status_full`) plus a **compact admin summary** by default:
    - totals by severity (`CRIT/WARN/UNKNOWN/SKIP/OK`)
    - severity-sorted minimal problems list (`STATUS monitor [reason=...]`)
  - Flags:
    - `--verbose` (show raw summary lines)
    - `--problems N` (default 20, max 100)
    - `--only OK|WARN|CRIT|UNKNOWN|SKIP`

- `linux-maint logs [N]` — tail latest wrapper log
- `linux-maint doctor` — diagnostics (paths, timers, permissions)
- `linux-maint init` — create initial config under `/etc/linux_maint`
- `linux-maint preflight` — preflight checks
- `linux-maint validate` — validate configuration
- `linux-maint install|uninstall` — wrapper around `install.sh`

## Exit codes

The project standard is:
- `0` = OK
- `1` = WARN
- `2` = CRIT
- `3` = UNKNOWN/ERROR

Wrapper returns the worst exit code across all executed monitors.

## Output artifacts

Artifacts are intended to be stable and automation-friendly.

Installed mode (default locations):

- Full run log:
  - `/var/log/health/full_health_monitor_<timestamp>.log`
  - symlink: `/var/log/health/full_health_monitor_latest.log`

- Summary log (one line per monitor):
  - `/var/log/health/full_health_monitor_summary_<timestamp>.log`
  - symlink: `/var/log/health/full_health_monitor_summary_latest.log`

- Summary JSON:
  - `/var/log/health/full_health_monitor_summary_<timestamp>.json`
  - symlink: `/var/log/health/full_health_monitor_summary_latest.json`

- Last status file:
  - `/var/log/health/last_status_full` (timestamp/host/overall/exit_code/logfile)

- Optional Prometheus textfile (node_exporter textfile collector):
  - `/var/lib/node_exporter/textfile_collector/linux_maint.prom`

Repo mode writes equivalent artifacts under `./.logs/`.

## Summary contract (line protocol)

Each monitor should emit at least one summary line:

```text
monitor=<name> host=<target> status=<OK|WARN|CRIT|UNKNOWN|SKIP> node=<runner> key=value...
```

Notes:
- Non-OK should ideally include `reason=<token>` (see `docs/REASONS.md`).
- Wrapper emits `SKIP` summary lines for monitors gated by missing optional config/baselines.

## Included monitors (current)

Located in `monitors/`:

<!-- AUTOGEN:MONITORS:START -->
- `backup_check`
- `cert_monitor`
- `config_drift_monitor`
- `config_validate`
- `disk_trend_monitor`
- `health_monitor`
- `inode_monitor`
- `inventory_export`
- `kernel_events_monitor`
- `network_monitor`
- `nfs_mount_monitor`
- `ntp_drift_monitor`
- `patch_monitor`
- `ports_baseline_monitor`
- `preflight_check`
- `service_monitor`
- `storage_health_monitor`
- `user_monitor`
<!-- AUTOGEN:MONITORS:END -->

## Configuration

Primary configuration lives under `/etc/linux_maint/`.

Notable config features:
- Main config: `/etc/linux_maint/linux-maint.conf`
- Optional drop-ins: `/etc/linux_maint/conf.d/*.conf`
- Additional lists/baselines under `/etc/linux_maint/` (hosts, excluded, services, ports baseline, certs, users/sudoers baselines, etc.)

Some monitors are gated by optional config/baseline files; wrapper emits `status=SKIP reason=missing:<path>`.

## Packaging / installation


Installer flags (from `install.sh`):

<!-- AUTOGEN:INSTALL_FLAGS:START -->
- `--prefix`
- `--purge`
- `--uninstall`
- `--user`
- `--with-logrotate`
- `--with-timer`
- `--with-user`
<!-- AUTOGEN:INSTALL_FLAGS:END -->

RPM packaging exists under `packaging/rpm/` (spec + systemd service/timer files).


## Tooling

- `tools/make_tarball.sh` — create an offline tarball
- `tools/gen_build_info.sh` — build metadata
- `tools/summary_diff.py` — compare/parse summary output (used by installed mode)
- `tools/update_readme_defaults.py` — keep docs defaults in sync

## Documentation

- `README.md` — overview + quickstart
- `docs/QUICK_REFERENCE.md` — operator cheat sheet
- `docs/reference.md` — full reference (monitors, knobs, offline/air-gapped, install)
- `docs/DARK_SITE.md` — offline/air-gapped notes
- `docs/REASONS.md` — reason tokens contract
- `ToDoList.txt` — prioritized actionable backlog

## 2026-02-09
- wrapper: add optional per-monitor timeout overrides via `MONITOR_TIMEOUTS_FILE`/`monitor_timeouts.conf` (and emit `reason=timeout` on wrapper timeout).
- tests: add `per_monitor_timeout_override_test.sh` and wire into smoke.
- monitors: ports_baseline_monitor now respects `LM_CFG_DIR` for baselines/allowlist paths (improves unprivileged testability without changing default behavior).

## 2026-02-09
- tests: add `summary_noise_lint.sh` guardrail to keep `monitor=` summary lines short (default max 220 chars), and wire it into smoke.

## 2026-02-09
- preflight_check: reduce summary noise by keeping only routing-relevant counts in `monitor=` lines; moved extra counters into full log.

## 2026-02-10
- tests: fix `monitor_summary_emission_test.sh` to run monitors with a writable `LM_CFG_DIR` (default `/tmp/linux_maint_cfg`) so baseline-based monitors can emit `monitor=` lines in CI.
echo "##active_line2##"
- docs/dev: add `Makefile` (lint/test convenience) and `CONTRIBUTING.md` (monitor contract + workflow).
echo "##active_line3##"
- ci: run ShellCheck with repo `.shellcheckrc` (stop excluding SC2086 globally in workflow).
echo "##active_line4##"
echo "##active_line2##"
- shellcheck: fix/annotate `user_monitor.sh` so CI passes without globally excluding SC2086.
echo "##active_line3##"
- shellcheck: align CI with `.shellcheckrc` and fix remaining SC2086 hits in summary emission for patch/storage/ports/user monitors.
echo "##active_line2##"
- shellcheck: quiet SC2317/SC2155 false-positives in backup_check and ntp_drift_monitor now that CI no longer excludes warnings globally.
echo "##active_line3##"
## 2026-02-10
echo "##active_line2##"
- shellcheck: quote summary key/value fields in disk_trend_monitor and kernel_events_monitor to satisfy SC2086 (no global exclude).
echo "##active_line2##"
## 2026-02-10
echo "##active_line2##"
- ci/shellcheck: keep CI excludes in sync with .shellcheckrc; fix accidental escaped quotes that triggered SC2086 in backup_check/inode_monitor/config_drift.
echo "##active_line2##"
## 2026-02-10
echo "##active_line2##"
- shellcheck: stop excluding SC2016/SC2162 globally; disable locally in scripts that intentionally build remote shell snippets or use read without -r.
echo "##active_line2##"
## 2026-02-10
echo "##active_line2##"
- ci: enforce meta-doc updates on PRs (require ToDoList.txt or summarize.txt when code changes), and fix diff range variable in docs_consistency workflow.
echo "##active_line2##"
## 2026-02-10
echo "##active_line2##"
- docs: replace ToDoList.txt with a refreshed prioritized roadmap (P0–P5) covering CI correctness, security hardening, operability, and new monitors.
echo "##active_line2##"
## 2026-02-10
echo "##active_line2##"
- tooling/ci: add `tools/shellcheck_wrapper.sh` and route CI/Makefile/pre-commit through it so `.shellcheckrc` is the single ShellCheck exclude source.
echo "##active_line2##"
## 2026-02-10
echo "##active_line2##"
- monitors: quote variable key=value fields in `lm_summary` across multiple monitors to prevent SC2086 and keep summary parsing robust.
echo "##active_line2##"
## 2026-02-10
echo "##active_line2##"
- tests: add `summary_parse_safety_lint` to ensure `monitor=` lines remain stable key=value tokens (required keys, no dup keys, no whitespace-in-values), and wire it into smoke.
echo "##active_line2##"
